# 实时语音转写功能使用说明

## 功能概述

本系统已集成实时语音转写功能，支持用户通过语音指令进行智能停车场预约、查询等操作。

## 技术架构

### 后端（Spring Boot）

1. **讯飞星火大模型（LLM）**
   - 用于自然语言理解和意图识别
   - 支持 NLU 模式（指令识别）和聊天模式（对话生成）
   - 配置位置：`application-dev.yml` 中的 `iflytek.spark`

2. **高德地图地理编码**
   - 将用户语音中的地点名称转换为经纬度坐标
   - 配置位置：`application-dev.yml` 中的 `amap.api-key`

3. **核心服务类**
   - `ChatService` - 星火大模型服务
   - `AmapService` - 高德地图地理编码服务
   - `VoiceService` - 语音指令处理调度中心

### 前端（微信小程序）

1. **微信同声传译插件**
   - 插件ID：`wx3030a84d9f33b5c6`
   - 版本：`0.3.5`
   - 配置位置：`miniprogram/app.json` 中的 `plugins`

2. **高德地图小程序 Key**
   - 配置位置：`miniprogram/app.js` 中的 `globalData.amapApiKey`

3. **语音转写工具类**
   - 文件位置：`miniprogram/utils/voiceRecognition.js`

## 配置说明

### 后端配置

#### 1. Maven 依赖（已添加）

```xml
<!-- HTTP客户端 - 用于讯飞星火API -->
<dependency>
    <groupId>com.squareup.okhttp3</groupId>
    <artifactId>okhttp</artifactId>
    <version>4.10.0</version>
</dependency>

<!-- JSON处理 - Gson -->
<dependency>
    <groupId>com.google.code.gson</groupId>
    <artifactId>gson</artifactId>
    <version>2.9.0</version>
</dependency>

<!-- 编码工具 - 用于HmacSHA256签名 -->
<dependency>
    <groupId>commons-codec</groupId>
    <artifactId>commons-codec</artifactId>
    <version>1.15</version>
</dependency>
```

#### 2. 配置文件（`application-dev.yml`）

```yaml
# 高德地图 (Geocoding - 地理编码)
amap:
  api-key: 37a5d69a69d267e7d4ee32b21dd8b897

# 讯飞星火大模型 (LLM + NLU)
iflytek:
  spark:
    appid: 7cd98dd6
    api-key: 778da35a3baa3d16282719d195a5a83d
    api-secret: NTBiNGFlNmFjZmFiZGVmNTU4YjlmNGY0
    chat-url: wss://spark-api.xf-yun.com/v4.0/chat
```

### 前端配置

#### 1. 小程序配置（`miniprogram/app.json`）

```json
{
  "plugins": {
    "WechatSI": {
      "version": "0.3.5",
      "provider": "wx3030a84d9f33b5c6"
    }
  },
  "permission": {
    "scope.record": {
      "desc": "您的声音将用于智能语音预约"
    }
  }
}
```

#### 2. 高德地图 Key（`miniprogram/app.js`）

```javascript
globalData: {
  amapApiKey: '6f2913cf2e046ca0e89c34f65cc2b810'
}
```

## 使用方式

### 前端使用示例

#### 1. 基本使用

```javascript
// 引入工具类
const voiceRecognition = require('../../utils/voiceRecognition');

// 初始化
voiceRecognition.initVoiceRecognition();

// 设置识别结果回调
voiceRecognition.setResultCallback((text) => {
  console.log('识别结果:', text);
  // 调用后端API处理
  processVoiceCommand(text);
});

// 开始录音
voiceRecognition.startRecord({ lang: 'zh_CN' });

// 停止录音
voiceRecognition.stopRecord();
```

#### 2. 在页面中使用

参考 `miniprogram/pages/voice/voice.js` 中的完整示例。

### 后端 API

#### 处理语音指令

**接口地址：** `POST /api/v1/voice/process`

**请求参数：**
```json
{
  "command": "预约北京路附近的停车场"
}
```

**响应示例：**
```json
{
  "status": "success",
  "message": "已找到北京路附近3个停车场",
  "commandType": "reserve",
  "data": {
    "location": "北京路",
    "longitude": 113.3248,
    "latitude": 23.1288,
    "total": 3,
    "parkings": [...]
  }
}
```

## 支持的语音指令

1. **预约附近停车场**
   - "预约北京路附近的停车场"
   - "预订广州塔附近的停车位"

2. **查询附近停车场**
   - "附近有什么停车场"
   - "附近停车场"

3. **导航**
   - "导航到北京路"
   - "带我去北京路"

4. **取消预约**
   - "取消预约"
   - "取消我的预约"

5. **查询状态**
   - "我的预约状态"
   - "当前预约"

6. **普通聊天**
   - "你好"
   - "谢谢"

## 工作流程

1. **用户说话** → 前端使用微信同声传译插件进行语音识别
2. **语音转文字** → 插件返回识别文本
3. **发送到后端** → 前端调用 `/api/v1/voice/process` 接口
4. **意图识别** → 后端使用星火大模型进行 NLU 分析
5. **地理编码** → 如果是地点相关指令，使用高德地图进行地理编码
6. **业务处理** → 调用相应的业务服务（查询停车场、预约等）
7. **返回结果** → 后端返回处理结果，前端展示

## 注意事项

1. **权限要求**
   - 小程序需要用户授权录音权限
   - 首次使用会弹出权限申请

2. **网络要求**
   - 需要稳定的网络连接
   - 语音识别和 API 调用都需要网络

3. **API 限制**
   - 讯飞星火 API 有调用频率限制
   - 高德地图 API 有每日调用量限制
   - 生产环境请合理控制调用频率

4. **错误处理**
   - 网络错误会自动重试
   - 识别失败会提示用户重新说话
   - API 调用失败会返回友好的错误提示

## 测试建议

1. **测试语音识别**
   - 在安静环境中测试
   - 使用清晰的普通话
   - 测试不同长度的语音

2. **测试意图识别**
   - 测试各种表达方式
   - 测试边界情况（空字符串、特殊字符等）

3. **测试地理编码**
   - 测试常见地点名称
   - 测试模糊地点名称
   - 测试不存在的地点

4. **测试业务流程**
   - 测试完整的预约流程
   - 测试错误处理流程
   - 测试并发请求

## 故障排查

### 问题1：语音识别失败

**可能原因：**
- 未授权录音权限
- 网络连接问题
- 插件未正确配置

**解决方法：**
1. 检查 `app.json` 中的插件配置
2. 检查用户是否授权录音权限
3. 检查网络连接

### 问题2：后端处理失败

**可能原因：**
- API Key 配置错误
- 网络连接问题
- 服务未启动

**解决方法：**
1. 检查 `application-dev.yml` 中的配置
2. 检查后端服务是否正常运行
3. 查看后端日志

### 问题3：意图识别不准确

**可能原因：**
- 用户表达方式不规范
- NLU 提示词需要优化

**解决方法：**
1. 优化 NLU 提示词（在 `ChatServiceImpl.java` 中）
2. 增加更多训练示例
3. 提供用户使用提示

## 后续优化建议

1. **增加语音提示**
   - 播放识别结果
   - 播放处理结果

2. **优化意图识别**
   - 增加更多意图类型
   - 优化 NLU 提示词

3. **增加语音合成（TTS）**
   - 将回复转换为语音播放

4. **增加离线支持**
   - 缓存常用地点
   - 离线识别常用指令

5. **性能优化**
   - 增加请求缓存
   - 优化 API 调用频率

