# 小程序三页面功能实现指南

## 一、首页功能实现

### 1.1 页面结构设计
```
┌─────────────────────────┐
│  智能停车场 (蓝色导航栏)  │
├─────────────────────────┤
│ ┌─────────────────────┐ │
│ │      搜索框         │ │  ← 支持停车场名称/位置搜索
│ └─────────────────────┘ │
│ ┌─────────────────────┐ │
│ │  快速预约 (蓝色按钮) │ │  ← 点击跳转至停车场页面
│ └─────────────────────┘ │
│ ┌─────────────────────┐ │
│ │  停车场概况卡片      │ │  ← 显示总车位/可用车位/使用率
│ └─────────────────────┘ │
│ ┌─────────────────────┐ │
│ │  公告通知列表        │ │  ← 滚动显示最新通知
│ └─────────────────────┘ │
│ ┌─────────────────────┐ │
│ │  常用停车场          │ │  ← 显示最近使用的3个停车场
│ └─────────────────────┘ │
└─────────────────────────┘
┌─────────────────────────┐
│ 首页  │ 停车场  │ 我的  │  ← 底部TabBar
└─────────────────────────┘
```

### 1.2 核心功能模块
| 模块名称 | 功能描述 | 技术实现 |
|---------|---------|---------|
| 搜索功能 | 关键词搜索停车场 | 绑定input事件，调用搜索API |
| 快速预约 | 一键进入预约流程 | navigator组件跳转至停车场页面 |
| 车位概览 | 显示停车场实时状态 | 调用统计API，渲染进度条组件 |
| 公告通知 | 展示系统通知 | scroll-view实现横向滚动 |
| 常用车场 | 显示历史记录 | 本地缓存+云数据库结合 |

### 1.3 数据接口设计
```javascript
// 1. 获取停车场统计数据
wx.request({
  url: 'https://api.parking.com/v1/stats/summary',
  method: 'GET',
  success: (res) => {
    this.setData({
      totalSpaces: res.data.total,
      availableSpaces: res.data.available,
      usageRate: res.data.usageRate // 百分比数值
    })
  }
})

// 2. 获取公告通知
wx.request({
  url: 'https://api.parking.com/v1/notifications',
  data: {
    page: 1,
    size: 3 // 获取最新3条
  },
  success: (res) => {
    this.setData({ notifications: res.data.list })
  }
})

// 3. 获取常用停车场 (本地缓存)
const frequentParks = wx.getStorageSync('frequentParks') || []
this.setData({ frequentParks })
```

### 1.4 交互逻辑
1. **搜索流程**：
   - 用户输入关键词 → 防抖处理(300ms) → 调用搜索API → 显示结果列表
   - 点击结果项 → 跳转至对应停车场详情页

2. **快速预约流程**：
   - 点击"快速预约"按钮 → 检查用户登录状态 → 未登录跳转至登录页
   - 已登录 → 跳转至停车场页面并默认选中最近使用车场

3. **下拉刷新**：
   - 下拉页面 → 触发onPullDownRefresh → 重新请求所有接口 → 停止刷新

### 1.5 Mock数据示例
```json
{
  "statsSummary": {
    "total": 500,
    "available": 127,
    "usageRate": 74.6,
    "updateTime": "2025-10-17 08:30"
  },
  "notifications": [
    {
      "id": 1,
      "title": "国庆期间停车费调整通知",
      "content": "10月1日-7日停车费上浮50%",
      "time": "2025-10-01"
    },
    {
      "id": 2,
      "title": "新停车场上线",
      "content": " downtown新增智能停车场，车位200个",
      "time": "2025-09-28"
    }
  ],
  "frequentParks": [
    {
      "id": "P001",
      "name": "中央商务区停车场",
      "distance": 1.2, // 公里
      "available": 35,
      "price": 10 // 元/小时
    }
  ]
}
```

## 二、停车场页面功能实现

### 2.1 页面结构设计
```
┌─────────────────────────┐
│  停车场 (蓝色导航栏)     │
├─────────────────────────┤
│ ┌─────────────────────┐ │
│ │  停车场选择器        │ │  ← 下拉选择不同停车场
│ └─────────────────────┘ │
│ ┌─────────────────────┐ │
│ │  车位状态图例        │ │  ← 可用/已占/已预约状态说明
│ └─────────────────────┘ │
│ ┌─────────────────────┐ │
│ │                     │ │
│ │    车位分布图        │ │  ← 2D网格展示车位布局
│ │                     │ │
│ └─────────────────────┘ │
│ ┌─────────────────────┐ │
│ │  预约信息面板        │ │  ← 显示选中车位和预约时长
│ └─────────────────────┘ │
│ ┌─────────────────────┐ │
│ │   确认预约 (按钮)    │ │  ← 蓝色主按钮，点击提交预约
│ └─────────────────────┘ │
└─────────────────────────┘
```

### 2.2 核心功能模块
| 模块名称 | 功能描述 | 技术实现 |
|---------|---------|---------|
| 停车场切换 | 多停车场选择功能 | picker组件 + 列表渲染 |
| 车位分布图 | 可视化展示车位状态 | 自定义canvas绘制或网格布局 |
| 车位选择 | 点击选择/取消车位 | 绑定tap事件 + 状态切换 |
| 预约时长选择 | 设置停车时长 | slider组件或时间选择器 |
| 费用计算 | 实时计算停车费用 | 根据时长和费率动态计算 |

### 2.3 数据接口设计
```javascript
// 1. 获取停车场列表
wx.request({
  url: 'https://api.parking.com/v1/parking/lots',
  success: (res) => {
    this.setData({
      parkingLots: res.data.list,
      currentLot: res.data.list[0] // 默认选中第一个
    })
  }
})

// 2. 获取车位状态数据
getParkingSpaces(lotId) {
  wx.request({
    url: `https://api.parking.com/v1/parking/${lotId}/spaces`,
    success: (res) => {
      this.setData({
        spaces: res.data.spaces, // 车位数组
        total: res.data.total,
        available: res.data.available
      })
    }
  })
}

// 3. 提交预约
submitReservation() {
  wx.request({
    url: 'https://api.parking.com/v1/reservations',
    method: 'POST',
    data: {
      parkingLotId: this.data.currentLot.id,
      spaceId: this.data.selectedSpace.id,
      startTime: new Date().toISOString(),
      duration: this.data.duration // 预约时长(分钟)
    },
    success: (res) => {
      wx.showToast({ title: '预约成功' })
      wx.navigateBack() // 返回首页
    }
  })
}
```

### 2.4 交互逻辑
1. **车位选择流程**：
   - 点击车位 → 判断状态：
     - 可用 → 选中并显示"已选"样式
     - 已占/已预约 → 显示提示"不可选"
   - 已选中状态下再次点击 → 取消选择

2. **预约流程**：
   - 选择停车场 → 加载车位数据 → 渲染车位图
   - 选择车位 → 选择预约时长 → 系统计算费用
   - 点击"确认预约" → 提交预约 → 成功后返回首页

3. **手势操作**：
   - 双指缩放：支持车位图缩放查看
   - 滑动：拖动查看大范围车位图
   - 长按：显示车位详情

### 2.5 Mock数据示例
```json
{
  "parkingLots": [
    {
      "id": "PL001",
      "name": "中央商务区停车场",
      "address": "科技路88号",
      "price": 10, // 元/小时
      "totalSpaces": 200,
      "floor": 3 // 地下3层
    },
    {
      "id": "PL002",
      "name": "火车站南广场停车场",
      "address": "站前大道12号",
      "price": 8,
      "totalSpaces": 150,
      "floor": 2
    }
  ],
  "spaces": [
    {
      "id": "A1-001",
      "number": "A1001",
      "status": 0, // 0-可用,1-已占,2-已预约
      "type": "standard", // 标准车位
      "x": 10, // 坐标位置
      "y": 20,
      "width": 5, // 大小
      "height": 10
    },
    // ...更多车位数据
  ]
}
```

## 三、"我的"页面功能实现

### 3.1 页面结构设计
```
┌─────────────────────────┐
│    我的 (蓝色导航栏)     │
├─────────────────────────┤
│ ┌─────────────────────┐ │
│ │                     │ │
│ │    用户头像         │ │  ← 圆形头像 + 昵称
│ │    用户名           │ │
│ │                     │ │
│ └─────────────────────┘ │
│ ┌─────────────────────┐ │
│ │  我的预约           │ │  ← 列表项，显示进行中/历史预约
│ └─────────────────────┘ │
│ ┌─────────────────────┐ │
│ │  停车记录           │ │  ← 查看历史停车记录
│ └─────────────────────┘ │
│ ┌─────────────────────┐ │
│ │  我的车辆           │ │  ← 管理绑定车辆信息
│ └─────────────────────┘ │
│ ┌─────────────────────┐ │
│ │  支付管理           │ │  ← 支付方式/账单/优惠券
│ └─────────────────────┘ │
│ ┌─────────────────────┐ │
│ │  设置               │ │  ← 系统设置入口
│ └─────────────────────┘ │
└─────────────────────────┘
```

### 3.2 核心功能模块
| 模块名称 | 功能描述 | 技术实现 |
|---------|---------|---------|
| 个人信息 | 显示/编辑用户信息 | 头像使用image组件，信息使用表单 |
| 我的预约 | 查看进行中和历史预约 | 列表渲染 + 状态标签 |
| 停车记录 | 查询历史停车记录 | 分页加载 + 筛选功能 |
| 车辆管理 | 绑定/解绑车辆 | list + 新增/删除操作 |
| 支付管理 | 管理支付方式和账单 | 跳转至支付相关页面 |

### 3.3 数据接口设计
```javascript
// 1. 获取用户信息
wx.request({
  url: 'https://api.parking.com/v1/user/profile',
  header: {
    'Authorization': 'Bearer ' + wx.getStorageSync('token')
  },
  success: (res) => {
    this.setData({ userInfo: res.data })
  }
})

// 2. 获取我的预约
getMyReservations() {
  wx.request({
    url: 'https://api.parking.com/v1/user/reservations',
    data: {
      status: 'active', // active:进行中, history:历史
      page: 1,
      size: 10
    },
    success: (res) => {
      this.setData({ reservations: res.data.list })
    }
  })
}

// 3. 获取车辆列表
wx.request({
  url: 'https://api.parking.com/v1/user/vehicles',
  success: (res) => {
    this.setData({ vehicles: res.data.list })
  }
})
```

### 3.4 交互逻辑
1. **预约管理流程**：
   - 点击"我的预约" → 显示进行中预约列表
   - 点击具体预约项 → 进入详情页，可取消预约(未开始)或查看详情
   - 切换"历史记录"标签 → 查看已完成预约

2. **车辆管理流程**：
   - 点击"我的车辆" → 显示已绑定车辆列表
   - 点击"添加车辆" → 跳转至添加页面，输入车牌等信息
   - 长按车辆项 → 弹出删除菜单，确认后解绑车辆

3. **个人信息编辑**：
   - 点击头像 → 选择相册或拍照更换头像
   - 点击信息项 → 弹出编辑框修改信息
   - 保存按钮 → 提交修改至服务器

### 3.5 Mock数据示例
```json
{
  "userInfo": {
    "nickname": "张三",
    "avatarUrl": "https://example.com/avatar/123.jpg",
    "phone": "138****5678",
    "memberLevel": "白银会员",
    "points": 350
  },
  "reservations": [
    {
      "id": "R123456",
      "parkingLotName": "中央商务区停车场",
      "spaceNumber": "A1001",
      "startTime": "2025-10-17T14:30:00Z",
      "endTime": "2025-10-17T18:30:00Z",
      "status": "active", // active/completed/cancelled
      "vehicleNumber": "京A12345"
    }
  ],
  "vehicles": [
    {
      "id": "V789",
      "number": "京A12345",
      "type": "小型车",
      "brand": "特斯拉",
      "color": "白色",
      "bindTime": "2025-09-10"
    }
  ]
}
```

## 四、通用功能实现

### 4.1 登录授权流程
1. 首次进入小程序 → 检查本地token
2. 无token → 显示登录按钮 → 点击调用wx.login
3. 获取code → 调用后端登录接口 → 获取token
4. 保存token至本地缓存 → 跳转至首页

```javascript
// 登录授权代码示例
login() {
  wx.login({
    success: (res) => {
      wx.request({
        url: 'https://api.parking.com/v1/auth/login',
        method: 'POST',
        data: {
          code: res.code,
          // 可选：用户信息
          userInfo: this.data.userInfo
        },
        success: (loginRes) => {
          wx.setStorageSync('token', loginRes.data.token)
          wx.navigateBack()
        }
      })
    }
  })
}
```

### 4.2 全局状态管理
使用getApp().globalData存储全局共享数据：
```javascript
// app.js
App({
  globalData: {
    userInfo: null,
    token: null,
    currentParkingLot: null
  }
})

// 页面中使用
const app = getApp()
this.setData({
  userInfo: app.globalData.userInfo
})
```

### 4.3 错误处理机制
统一封装请求错误处理：
```javascript
// 封装request方法
function request(options) {
  return new Promise((resolve, reject) => {
    wx.request({
      ...options,
      header: {
        'Authorization': 'Bearer ' + wx.getStorageSync('token'),
        ...options.header
      },
      success: (res) => {
        if (res.data.code === 401) {
          // 未授权，跳转登录
          wx.navigateTo({ url: '/pages/login/login' })
          reject('未授权')
        } else if (res.data.code !== 0) {
          // 其他错误
          wx.showToast({
            title: res.data.message || '操作失败',
            icon: 'none'
          })
          reject(res.data)
        } else {
          resolve(res.data)
        }
      },
      fail: (err) => {
        wx.showToast({ title: '网络错误', icon: 'none' })
        reject(err)
      }
    })
  })
}
```

## 五、开发规范与注意事项

### 5.1 代码规范
1. **目录结构**：
```
pages/
├── home/           # 首页
│   ├── index.js
│   ├── index.wxml
│   ├── index.wxss
│   └── index.json
├── parking/        # 停车场页面
└── my/             # 我的页面
```

2. **命名规范**：
   - 页面文件：index.js/wxml/wxss/json
   - 组件：使用kebab-case命名，如parking-space
   - 方法：使用camelCase命名，如submitReservation
   - 常量：使用UPPER_SNAKE_CASE命名，如MAX_DURATION

### 5.2 性能优化
1. **数据绑定优化**：
   - 减少setData调用次数，合并数据更新
   - 避免绑定大型数据集，使用分页加载

2. **图片优化**：
   - 头像等小图使用缩略图
   - 列表图片使用懒加载

3. **缓存策略**：
   - 使用wx.setStorageSync缓存不常变化数据
   - 停车场列表、用户信息等使用缓存+定时更新

### 5.3 兼容性处理
1. **适配不同屏幕**：
   - 使用rpx单位进行布局
   - 关键区域使用flex布局

2. **低版本兼容**：
   - 使用wx.canIUse检查API支持情况
   - 提供降级方案，如不支持canvas时使用静态图片

## 六、开发进度规划

| 阶段 | 任务内容 | 预计工时 |
|-----|---------|---------|
| 1 | 首页UI实现 | 4小时 |
| 2 | 停车场页面UI实现 | 6小时 |
| 3 | 我的页面UI实现 | 5小时 |
| 4 | 首页功能开发 | 8小时 |
| 5 | 停车场功能开发 | 10小时 |
| 6 | 我的页面功能开发 | 8小时 |
| 7 | 联调测试与修复 | 6小时 |
| 总计 |  | 47小时 |

## 七、参考文档
1. [微信小程序开发文档](https://developers.weixin.qq.com/miniprogram/dev/framework/)
2. [核心功能开发实施手册.md](核心功能开发实施手册.md)
3. [小程序蓝白色系界面修改指南.md](小程序蓝白色系界面修改指南.md)
4. [智能停车场API接口文档](https://api.parking.com/docs)