# 数据库一致性核对说明

## 问题概述

前端展示的停车场数据库和后端数据库存在不匹配的问题，导致预约时显示错误的停车场信息。

## 已发现的问题

### 1. 字段名不一致
- **数据库表字段**：可能使用 `parking_id`、`parking_lot_id` 或 `lot_id`
- **实体类字段**：使用 `parkingId`（会映射为 `parking_id`）
- **SQL映射文件**：原本使用 `parking_lot_id`，现已修复为兼容多种字段名

### 2. 前端使用模拟数据
- 部分前端API（如 `fetchParkingDetail`）仍使用模拟数据
- 需要改为调用真实的后端API

## 已修复的内容

### ✅ 修复1：SQL映射文件字段兼容
**文件**：`src/main/resources/mapper/ParkingSpaceMapper.xml`
- 修复了 `selectById` 和 `selectAvailableSpaces` 查询
- 使用 `COALESCE(parking_id, parking_lot_id, lot_id)` 兼容多种字段名
- 添加了完整的字段映射（AS别名）

### ✅ 修复2：前端API调用
**文件**：`vue-parking-system/src/api/parking.js`
- 添加了 `fetchParkingList` 函数，调用后端API获取停车场列表
- 添加了 `fetchParkingSpaces` 和 `fetchFloorSpaces` 函数

### ✅ 修复3：预约详情页面
**文件**：`vue-parking-system/src/views/ReservationDetail.vue`
- 从使用模拟数据改为调用后端API
- 修复了字段映射问题（`parkingLotName` -> `parkingName`）

## 核对步骤

### 步骤1：检查数据库字段

运行以下脚本检查数据库实际使用的字段名：

```bash
mysql -uroot -p123 parking_db < check_database_fields.bat
```

或者直接执行SQL：
```sql
USE parking_db;
SELECT COLUMN_NAME FROM INFORMATION_SCHEMA.COLUMNS
WHERE TABLE_SCHEMA = 'parking_db'
  AND TABLE_NAME = 'parking_space'
  AND (COLUMN_NAME LIKE '%parking%' OR COLUMN_NAME LIKE '%lot%');
```

### 步骤2：运行数据库一致性检查

执行检查脚本：
```bash
mysql -uroot -p123 parking_db < check_database_consistency.sql
```

或者使用批处理文件：
```bash
verify_database_consistency.bat
```

### 步骤3：修复数据库字段（如果需要）

如果发现字段名不一致，执行修复脚本：
```bash
mysql -uroot -p123 parking_db < fix_database_consistency.sql
```

## 数据库表结构要求

### parking_lot 表（停车场表）
应该包含以下字段：
- `id` - 停车场ID
- `name` - 停车场名称（如"白云山风景区停车场"、"太古汇停车场"）
- `address` - 停车场地址
- `total_spaces` - 总车位数
- `available_spaces` - 可用车位数
- `hourly_rate` - 每小时费率

### parking_space 表（车位表）
**关键字段**：必须有一个字段关联到 `parking_lot.id`，可能的名字：
- `parking_id` ✅（推荐，已修复SQL兼容）
- `parking_lot_id` ✅（已修复SQL兼容）
- `lot_id` ✅（已修复SQL兼容）

应该包含以下字段：
- `id` - 车位ID（主键）
- `space_number` - 车位编号
- `parking_id` 或 `parking_lot_id` 或 `lot_id` - 停车场ID（外键）
- `status` - 车位状态（'AVAILABLE', 'OCCUPIED', 'RESERVED'）
- `state` - 数字状态（0-空闲，1-锁定，2-占用）
- `is_available` - 是否可用（1-可用，0-不可用）
- `floor` - 楼层信息

## 验证方法

### 1. 检查数据库中的停车场数据

```sql
SELECT id, name, address FROM parking_lot ORDER BY id;
```

应该看到类似：
- ID=1: 太古汇停车场
- ID=7: 白云山风景区停车场

### 2. 检查车位数据

```sql
SELECT 
    ps.id,
    ps.space_number,
    COALESCE(ps.parking_id, ps.parking_lot_id, ps.lot_id) AS parking_id,
    pl.name AS parking_name
FROM parking_space ps
LEFT JOIN parking_lot pl ON pl.id = COALESCE(ps.parking_id, ps.parking_lot_id, ps.lot_id)
LIMIT 10;
```

### 3. 测试预约功能

1. 在前端选择白云山停车场的车位
2. 提交预约
3. 查看预约详情页面
4. 确认显示的停车场名称是"白云山风景区停车场"而不是其他

## 注意事项

1. **数据源统一**：确保所有停车场数据来自 `update_guangzhou_parking_lots.sql` 或Excel文件
2. **字段映射**：SQL查询已修复为兼容多种字段名，但建议统一使用 `parking_id`
3. **前端API**：部分API仍使用模拟数据，需要逐步替换为真实API调用

## 下一步操作

1. **运行检查脚本**：`verify_database_consistency.bat`
2. **查看检查结果**：确认字段名和数据一致性
3. **如果需要修复**：运行 `fix_database_consistency.sql`
4. **测试预约功能**：确保显示正确的停车场名称

