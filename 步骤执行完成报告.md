# æ­¥éª¤æ‰§è¡Œå®ŒæˆæŠ¥å‘Š

## âœ… æ‰€æœ‰æ­¥éª¤å·²å®Œæˆ

### æ­¥éª¤ 1ï¼špom.xml ä¾èµ–æ·»åŠ  âœ…

**çŠ¶æ€**: âœ… å·²å®Œæˆ

**æ–‡ä»¶**: `pom.xml`

**å·²æ·»åŠ çš„ä¾èµ–**:
```xml
<!-- HTTPå®¢æˆ·ç«¯ - ç”¨äºè®¯é£æ˜Ÿç«API -->
<dependency>
    <groupId>com.squareup.okhttp3</groupId>
    <artifactId>okhttp</artifactId>
    <version>4.10.0</version>
</dependency>

<!-- JSONå¤„ç† - Gson -->
<dependency>
    <groupId>com.google.code.gson</groupId>
    <artifactId>gson</artifactId>
    <version>2.9.0</version>
</dependency>

<!-- ç¼–ç å·¥å…· - ç”¨äºHmacSHA256ç­¾å -->
<dependency>
    <groupId>commons-codec</groupId>
    <artifactId>commons-codec</artifactId>
    <version>1.15</version>
</dependency>
```

**ä½ç½®**: ç¬¬96-115è¡Œ

---

### æ­¥éª¤ 2ï¼šapplication-dev.yml é…ç½® âœ…

**çŠ¶æ€**: âœ… å·²å®Œæˆ

**æ–‡ä»¶**: `src/main/resources/application-dev.yml`

**å·²é…ç½®çš„å†…å®¹**:
```yaml
# é«˜å¾·åœ°å›¾ (Geocoding - åœ°ç†ç¼–ç )
amap:
  api-key: 37a5d69a69d267e7d4ee32b21dd8b897

# è®¯é£æ˜Ÿç«å¤§æ¨¡å‹ (LLM + NLU)
iflytek:
  spark:
    appid: 7cd98dd6
    api-key: 778da35a3baa3d16282719d195a5a83d
    api-secret: NTBiNGFlNmFjZmFiZGVmNTU4YjlmNGY0
    chat-url: wss://spark-api.xf-yun.com/v4.0/chat
```

**ä½ç½®**: ç¬¬19-53è¡Œ

---

### æ­¥éª¤ 3ï¼šChatServiceImpl.java å‡çº§ âœ…

**çŠ¶æ€**: âœ… å·²å®Œæˆ

**æ–‡ä»¶**: `src/main/java/com/parking/service/impl/ChatServiceImpl.java`

**å·²å®ç°çš„åŠŸèƒ½**:
- âœ… OkHttp WebSocket è¿æ¥
- âœ… HMAC-SHA256 é‰´æƒç­¾å (`generateAuthUrl` æ–¹æ³•)
- âœ… WebSocketListener ç›‘å¬å™¨å®ç°
- âœ… `getNluResponse` æ–¹æ³•ï¼ˆNLUæ¨¡å¼ï¼ŒæŒ‡ä»¤1ï¼‰
- âœ… `getChatResponse` æ–¹æ³•ï¼ˆèŠå¤©æ¨¡å¼ï¼ŒæŒ‡ä»¤2ï¼‰
- âœ… å®Œæ•´çš„æ¶ˆæ¯æ„å»ºå’Œè§£æé€»è¾‘

**å…³é”®ç‰¹æ€§**:
- ä½¿ç”¨ `wss://spark-api.xf-yun.com/v4.0/chat` è¿æ¥
- æ”¯æŒ30ç§’è¶…æ—¶æœºåˆ¶
- å®Œæ•´çš„é”™è¯¯å¤„ç†

---

### æ­¥éª¤ 4ï¼šVoiceServiceImpl.java å‡çº§ âœ…

**çŠ¶æ€**: âœ… å·²å®Œæˆ

**æ–‡ä»¶**: `src/main/java/com/parking/service/impl/VoiceServiceImpl.java`

**å·²å®ç°çš„åŠŸèƒ½**:
- âœ… æ³¨å…¥ `ChatService` å’Œ `AmapService`
- âœ… "å…ˆNLUï¼ŒåChat"çš„è°ƒåº¦é€»è¾‘
- âœ… `handleReserveNearbyCommand` æ–¹æ³•ï¼ˆå¤„ç†é¢„çº¦é™„è¿‘åœ°ç‚¹ï¼‰
- âœ… é›†æˆé«˜å¾·åœ°ç†ç¼–ç 
- âœ… é›†æˆåœè½¦åœºæŸ¥è¯¢æœåŠ¡

**è°ƒåº¦æµç¨‹**:
1. è°ƒç”¨ `chatService.getNluResponse()` è¿›è¡Œæ„å›¾è¯†åˆ«
2. å¦‚æœè¿”å› UNKNOWNï¼Œè°ƒç”¨ `chatService.getChatResponse()` è¿›è¡ŒèŠå¤©å›å¤
3. æ ¹æ®æ„å›¾ç±»å‹ï¼ˆRESERVE_NEARBYç­‰ï¼‰æ‰§è¡Œç›¸åº”ä¸šåŠ¡é€»è¾‘
4. ä½¿ç”¨ `amapService.geocode()` è¿›è¡Œåœ°ç†ç¼–ç 
5. ä½¿ç”¨ `parkingService.getNearbyParkings()` æŸ¥è¯¢åœè½¦åœº

---

### æ­¥éª¤ 5ï¼šVoiceCommandResult.java å‡çº§ âœ…

**çŠ¶æ€**: âœ… å·²å®Œæˆ

**æ–‡ä»¶**: `src/main/java/com/parking/model/vo/VoiceCommandResult.java`

**å·²æ·»åŠ çš„å†…å®¹**:
- âœ… `followUpAction` å­—æ®µï¼ˆStringç±»å‹ï¼‰
- âœ… `prefillData` å­—æ®µï¼ˆMap<String, Object>ç±»å‹ï¼‰
- âœ… `successWithFollowUp` é™æ€æ–¹æ³•

**æ–¹æ³•ç­¾å**:
```java
public static VoiceCommandResult successWithFollowUp(
    String message, 
    String commandType, 
    String followUpAction, 
    Map<String, Object> prefillData
)
```

**å¯¼å…¥**: å·²æ·»åŠ  `import java.util.Map;`

---

## ğŸ“‹ éªŒè¯æ¸…å•

### ä»£ç å®Œæ•´æ€§æ£€æŸ¥
- [x] pom.xml åŒ…å«æ‰€æœ‰å¿…éœ€ä¾èµ–
- [x] application-dev.yml åŒ…å«æ‰€æœ‰API Key
- [x] ChatServiceImpl.java æœ‰å®Œæ•´çš„WebSocketå®ç°
- [x] VoiceServiceImpl.java æœ‰å®Œæ•´çš„è°ƒåº¦é€»è¾‘
- [x] VoiceCommandResult.java æœ‰æ­£ç¡®çš„ç±»å‹å®šä¹‰

### ç¼–è¯‘æ£€æŸ¥
- [x] æ— ç¼–è¯‘é”™è¯¯
- [x] æ— Linteré”™è¯¯
- [x] æ‰€æœ‰å¯¼å…¥è¯­å¥æ­£ç¡®

---

## ğŸš€ ä¸‹ä¸€æ­¥æ“ä½œ

### 1. åˆ·æ–°Mavenä¾èµ–
```bash
mvn clean install
```
æˆ–åœ¨IDEä¸­ï¼š
- IntelliJ IDEA: å³é”® `pom.xml` > `Maven` > `Reload Project`
- Eclipse: å³é”®é¡¹ç›® > `Maven` > `Update Project`

### 2. é‡å¯åç«¯æœåŠ¡
ç¡®ä¿æ–°çš„é…ç½®å’Œä¾èµ–ç”Ÿæ•ˆ

### 3. æµ‹è¯•åŠŸèƒ½
- æµ‹è¯•è¯­éŸ³æŒ‡ä»¤å¤„ç†ï¼š`POST /api/v1/voice/process`
- æµ‹è¯•é«˜å¾·åœ°ç†ç¼–ç ï¼šè°ƒç”¨ `AmapService.geocode()`
- æµ‹è¯•æ˜Ÿç«å¤§æ¨¡å‹è¿æ¥ï¼šæ£€æŸ¥WebSocketè¿æ¥æ˜¯å¦æ­£å¸¸

---

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **API Keyå®‰å…¨**
   - å½“å‰é…ç½®åœ¨ `application-dev.yml` ä¸­
   - ç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–é…ç½®ä¸­å¿ƒ

2. **ç½‘ç»œè¦æ±‚**
   - æ˜Ÿç«å¤§æ¨¡å‹éœ€è¦ç¨³å®šçš„ç½‘ç»œè¿æ¥
   - WebSocketè¿æ¥è¶…æ—¶æ—¶é—´ä¸º30ç§’

3. **é”™è¯¯å¤„ç†**
   - æ‰€æœ‰APIè°ƒç”¨éƒ½æœ‰å¼‚å¸¸å¤„ç†
   - ç½‘ç»œé”™è¯¯ä¼šè¿”å›å‹å¥½çš„é”™è¯¯æç¤º

---

## âœ… å®ŒæˆçŠ¶æ€

**æ‰€æœ‰5ä¸ªæ­¥éª¤å·²å®Œæˆï¼**

- âœ… æ­¥éª¤1: pom.xml ä¾èµ–æ·»åŠ 
- âœ… æ­¥éª¤2: application-dev.yml é…ç½®
- âœ… æ­¥éª¤3: ChatServiceImpl.java å‡çº§
- âœ… æ­¥éª¤4: VoiceServiceImpl.java å‡çº§
- âœ… æ­¥éª¤5: VoiceCommandResult.java å‡çº§

**ä»£ç å·²å°±ç»ªï¼Œå¯ä»¥å¼€å§‹æµ‹è¯•ï¼**

---

**æœ€åæ›´æ–°**: 2025å¹´
**çŠ¶æ€**: âœ… å…¨éƒ¨å®Œæˆ

