# 智能停车场小程序开发规范

## 1. 概述

本文档整合了微信小程序官方开发规范与项目特定要求，旨在指导智能停车场小程序的开发、测试和部署过程。所有开发人员必须严格遵守本规范，确保代码质量和项目一致性。

## 2. 项目结构规范

### 2.1 标准目录树结构

```
d:/Park(Wechat)/
├── .env                  # 环境变量配置（必须忽略提交）
├── .env.example          # 环境变量示例（必须提交到仓库）
├── .gitignore            # Git忽略规则（必须包含.env/.log）
├── app.js                # 小程序入口文件
├── app.json              # 全局配置文件
├── app.wxss              # 全局样式文件
├── pages/                # 页面文件夹
│   ├── index/            # 首页
│   ├── login/            # 登录页
│   ├── mine/             # 个人中心
│   ├── parking-detail/   # 停车场详情
│   └── ...
├── components/           # 自定义组件
├── utils/                # 工具函数
│   ├── amap.js           # 高德地图API工具
│   └── ...
├── styles/               # 公共样式
├── images/               # 图片资源
├── services/             # 业务服务
├── API配置说明.md        # API配置指南
└── 小程序开发规范.md      # 开发规范文档
```

### 2.2 文件命名规范

| 文件类型 | 命名规则 | 示例 | 必须/应/建议 |
|---------|---------|------|------------|
| 源代码文件 | kebab-case.js | `parking-list.js` | 必须 |
| 组件文件 | PascalCase.js | `ParkingCard.js` | 必须 |
| 测试文件 | [源文件名].test.js | `parking-service.test.js` | 必须 |
| 配置文件 | snake_case.json | `app_config.json` | 必须 |
| 文档文件 | kebab-case.md | `api-guidelines.md` | 必须 |
| 脚本文件 | kebab-case.sh | `deploy-production.sh` | 必须 |

## 3. 环境配置规范

### 3.1 环境变量配置

#### 3.1.1 配置文件位置
- **必须**在项目根目录创建 `.env` 文件（开发环境）
- **必须**将 `.env` 添加到 `.gitignore` 文件
- **必须**提供 `.env.example` 作为配置模板

#### 3.1.2 必要参数示例
```bash
# 应用基础配置
APP_NAME="智能停车场系统"
APP_ENV="development"  # 必须为: development/test/production
APP_PORT=8080
APP_DEBUG="true"       # 生产环境必须设为"false"

# 第三方服务配置（必须脱敏存储）
AMAP_API_KEY="********************************"  # 高德地图API密钥
WECHAT_APPID="wx****************"
WECHAT_MCH_ID="1********9"
LOG_LEVEL="info"  # 必须为: debug/info/warn/error/fatal
```

### 3.2 依赖管理策略

#### 3.2.1 安装规范
- **必须**使用锁定文件固定依赖版本：`package-lock.json`
- **必须**执行依赖安全检查：`npm audit --production`

#### 3.2.2 更新流程
1. **必须**创建单独的更新分支：`feature/update-dependencies`
2. **必须**逐个更新依赖并验证功能：`npm update <package> --save-exact`
3. **必须**在提交信息中注明更新内容：`chore(deps): 更新axios至1.2.1版本`

## 4. 代码编写规范

### 4.1 JavaScript编码规范

#### 4.1.1 基本规范
- 使用2个空格进行缩进
- 使用单引号 `'` 而非双引号 `"`
- 每行代码不超过80个字符
- 末尾必须添加分号 `;`
- 文件末尾保留一个空行
- 必须使用UTF-8编码且无BOM头

#### 4.1.2 命名规则

| 标识符类型 | 命名规则 | 示例 | 必须/应/建议 |
|---------|---------|------|------------|
| 变量/函数 | camelCase | `userInfo`, `calculateFee()` | 必须 |
| 常量 | UPPER_SNAKE_CASE | `MAX_RETRY_COUNT`, `API_BASE_URL` | 必须 |
| 类/组件 | PascalCase | `class UserService`, `component ParkingCard` | 必须 |
| 接口 | I+PascalCase | `interface IReservation` | 必须 |
| 枚举 | PascalCase+Enum | `enum ReservationStatusEnum` | 必须 |
| 私有成员 | _+camelCase | `_privateMethod()` | 应 |

#### 4.1.3 注释规范
- **必须**为以下内容提供注释：
  - 函数/方法（JSDoc格式）
  - 复杂业务逻辑（单行注释）
  - 常量定义（说明用途而非值）
- **禁止**注释显而易见的代码

```javascript
/**
 * 获取附近停车场信息
 * @param {Object} location - 位置信息 {latitude, longitude}
 * @param {Function} success - 成功回调
 * @param {Function} fail - 失败回调
 * @returns {void}
 */
function getNearbyParks(location, success, fail) {
  // 检查API密钥是否有效
  if (!this.checkApiKey()) {
    // 使用模拟数据作为备选
    const mockData = this.getMockParks();
    success && success(mockData);
    return;
  }
  // ...
}
```

### 4.2 WXML编码规范

- 使用小写字母和连字符 `-` 命名自定义组件和属性
- 组件属性必须换行对齐
- 禁止在WXML中直接写业务逻辑
- 使用 `wx:if`/`wx:elif`/`wx:else` 进行条件渲染
- 使用 `wx:for` 进行列表渲染，必须指定 `wx:key`

```html
<!-- 正确示例 -->
<view class="parking-card">
  <view class="parking-name">{{parking.name}}</view>
  <view class="parking-info">
    <text class="address">{{parking.address}}</text>
    <text class="distance">{{parking.distance}}m</text>
  </view>
  <view class="parking-status" wx:if="{{parking.availableCount > 0}}">
    可停{{parking.availableCount}}辆
  </view>
  <view class="parking-status full" wx:else>
    已满
  </view>
</view>
```

### 4.3 WXSS编码规范

- 使用BEM命名法：`block__element--modifier`
- 样式属性顺序：布局相关 > 盒模型 > 视觉 > 其他
- 避免使用ID选择器
- 优先使用class选择器
- 公共样式提取到全局或专用样式文件

```css
/* 正确示例 */
.parking-card {
  display: flex;
  flex-direction: column;
  padding: 12rpx;
  margin-bottom: 10rpx;
  background-color: #fff;
  border-radius: 8rpx;
}

.parking-card__info {
  display: flex;
  justify-content: space-between;
  margin-top: 8rpx;
}

.parking-card__status--full {
  color: #e64340;
}
```

### 4.4 JSON配置规范

- 缩进使用2个空格
- 配置项按功能分组排列
- 必须添加必要的注释说明

## 5. 微信小程序特有规范

### 4.1 App配置规范

```javascript
// app.js
App({
  // 全局数据定义
  globalData: {
    userInfo: null,
    isLogin: false,
    amapApiKey: 'your_api_key_here' // 高德地图API密钥
  },

  // 小程序初始化
  onLaunch: function() {
    // 初始化操作
    this.checkLoginStatus();
    console.log('小程序初始化完成');
  },

  // 其他全局方法
  checkLoginStatus: function() {
    // 实现登录检查逻辑
  }
});
```

### 5.2 Page配置规范

```javascript
// pages/index/index.js
Page({
  // 页面数据
  data: {
    parkingList: [],
    currentLocation: null,
    loading: false
  },

  // 页面加载
  onLoad: function(options) {
    this.loadNearbyParks();
  },

  // 页面显示
  onShow: function() {
    // 每次显示页面时执行
  },

  // 自定义方法
  loadNearbyParks: function() {
    const that = this;
    that.setData({
      loading: true
    });
    
    // 调用API获取数据
    // ...
  }
});
```

### 5.3 组件开发规范

```javascript
// components/ParkingCard.js
Component({
  // 组件属性
  properties: {
    parkingInfo: {
      type: Object,
      value: {}
    },
    showDistance: {
      type: Boolean,
      value: true
    }
  },

  // 组件数据
  data: {
    formattedDistance: ''
  },

  // 组件生命周期
  lifetimes: {
    attached: function() {
      this.formatDistance();
    }
  },

  // 组件方法
  methods: {
    formatDistance: function() {
      // 实现距离格式化逻辑
    },
    onTap: function() {
      // 触发自定义事件
      this.triggerEvent('parkingtap', {
        parkingId: this.properties.parkingInfo.id
      });
    }
  }
});
```

### 5.4 权限配置规范

- **必须**在app.json中明确声明使用的权限及用途
- **必须**遵循最小权限原则申请权限
- **必须**获取权限前向用户说明使用目的

```json
{
  "permission": {
    "scope.userLocation": {
      "desc": "您的位置信息将用于为您推荐附近的停车场"
    }
  }
}
```

## 6. API调用规范

### 5.1 网络请求

- 统一使用 `wx.request` 进行网络请求
- 设置合理的超时时间（默认5秒）
- 实现统一的错误处理和重试机制
- 添加请求加载状态和失败反馈

```javascript
function request(url, data, success, fail, complete) {
  wx.showLoading({
    title: '加载中',
  });

  wx.request({
    url: url,
    data: data,
    method: 'GET',
    timeout: 5000,
    success: function(res) {
      if (res.statusCode === 200) {
        success && success(res.data);
      } else {
        fail && fail(new Error('请求失败: ' + res.statusCode));
      }
    },
    fail: function(err) {
      console.error('网络请求失败:', err);
      fail && fail(err);
    },
    complete: function() {
      wx.hideLoading();
      complete && complete();
    }
  });
}
```

### 6.2 高德地图API使用规范

- 所有地图相关功能封装在 `utils/amap.js` 中
- API密钥从全局配置获取，禁止硬编码
- 实现API调用失败的降级处理（使用模拟数据）
- 优化请求参数，减少不必要的API调用
- 验证API密钥有效性，提供明确的错误提示

## 7. 模块化与组件化开发

### 7.1 模块化要求
- **必须**遵循单一职责原则：一个模块只负责一个功能
- **必须**通过 `index.js` 暴露模块公共接口
- **必须**限制模块依赖深度不超过3层

```javascript
// utils/index.js
export { formatDate } from './date';
export { request } from './request';
export { amap } from './amap';
// 禁止导出未在index.js声明的内部函数
```

### 7.2 组件化要求
- **必须**将UI组件拆分为：页面组件（pages）/ 通用组件（components）
- **必须**为每个组件编写独立的单元测试
- **应**通过props控制组件行为，禁止组件内部硬编码业务逻辑

## 8. 安全编码规范

### 8.1 输入验证
- **必须**对所有用户输入进行验证
- **必须**使用参数化查询防止SQL注入

```javascript
// 禁止直接使用用户输入
const userId = req.query.userId;

// 必须验证并转换
const userId = parseInt(req.query.userId, 10);
if (isNaN(userId) || userId <= 0) {
  throw new Error('无效的用户ID');
}
```

### 8.2 XSS防护
- **必须**对输出到HTML的内容进行转义
- **必须**设置适当的Content-Security-Policy

### 8.3 敏感数据保护
- **必须**加密存储敏感数据
- **必须**在日志中脱敏敏感信息

```javascript
// 错误示例
logger.info(`用户${username}登录成功，IP:${ip}`);

// 正确示例
logger.info(`用户${maskUsername(username)}登录成功，IP:${maskIp(ip)}`);
```

## 9. 错误处理与日志规范

### 9.1 错误码体系

#### 9.1.1 错误码格式
- **必须**使用5位数字错误码：`ABCCC`
  - A: 错误类型（1=系统错误，2=业务错误，3=外部错误）
  - B: 模块编号（0-9）
  - CCC: 具体错误编号（001-999）

#### 9.1.2 关键错误码

| 错误码 | 错误信息 | HTTP状态码 | 处理建议 |
|-------|---------|-----------|---------|
| 10001 | 数据库连接失败 | 500 | 检查数据库服务状态和连接参数 |
| 20001 | 车位不存在 | 404 | 检查停车场ID和车位编号是否正确 |
| 30001 | 地图API调用失败 | 502 | 检查API密钥和网络连接 |

### 9.2 日志记录格式

- **必须**使用JSON格式记录日志
- **必须**包含timestamp、level、service、traceId、userId等关键字段
- **必须**根据环境配置日志级别（debug/info/warn/error/fatal）

```json
{
  "permission": {
    "scope.userLocation": {
      "desc": "您的位置信息将用于为您推荐附近的停车场"
    }
  }
}
```

## 10. 版本控制策略

### 10.1 分支管理
- **必须**遵循GitFlow工作流：
  - `main`: 生产环境分支（禁止直接提交）
  - `develop`: 开发分支（仅接受合并请求）
  - `feature/*`: 功能分支（从develop创建，完成后合并回develop）
  - `release/*`: 发布分支（从develop创建，完成后合并到main和develop）
  - `hotfix/*`: 紧急修复分支（从main创建，完成后合并到main和develop）

### 10.2 提交信息格式
- **必须**使用以下格式：`<类型>[可选作用域]: <描述>`
- **类型**必须为以下之一：
  - `feat`: 新功能
  - `fix`: 缺陷修复
  - `docs`: 文档更新
  - `style`: 代码格式调整（不影响逻辑）
  - `refactor`: 代码重构
  - `test`: 测试相关
  - `chore`: 构建/依赖管理
- **必须**使用英文撰写提交信息

## 11. 性能优化

### 7.1 渲染优化

- 使用虚拟列表渲染长列表
- 避免在 `onPageScroll` 中频繁调用 `setData`
- 合理使用 `wx:if` 和 `hidden`
- 组件化开发，提高代码复用性

### 7.2 资源优化

- 图片使用适当尺寸和格式
- 延迟加载非首屏内容
- 合理使用缓存机制
- 减少不必要的网络请求

## 12. 测试与调试

### 8.1 代码检查

- 使用 `eslint` 进行代码质量检查
- 确保所有JS文件通过语法检查：`node -c file.js`
- 定期执行代码审查

### 12.2 测试要求

- **必须**达到80%以上的代码覆盖率
- **必须**编写测试用例覆盖以下场景：
  - 正常业务流程
  - 边界条件（如最大/最小值）
  - 错误处理（如参数错误/异常抛出）

### 12.3 调试技巧

- 使用 `console.log` 进行调试，但发布前必须移除
- 利用微信开发者工具的调试功能
- 设置合理的错误捕获和日志记录

## 13. AI交互优化设计

### 13.1 文档结构化标准

- **必须**使用Markdown标准标题层级
- **必须**确保标题层级连续（禁止跳过层级）
- **必须**为每个章节提供唯一ID

```markdown
## 2.1 标准目录树结构 {#dir-structure}
```

### 13.2 列表格式规范

- **必须**使用无序列表（`- `）表示并列项
- **必须**使用有序列表（`1. `）表示步骤序列
- **必须**使用任务列表（`- [ ]`）表示待办事项

### 13.3 关键信息标记方法

- **必须**为关键表格添加ID
- **必须**使用表头行明确列定义（禁止无表头表格）

### 13.4 歧义消除规则

- **必须**提供术语定义表和缩写对照表
- **必须**使用`<!-- AI-MARKER: 类型 -->`标记关键信息

## 14. 最佳实践

### 9.1 Git提交规范

- 提交信息格式：`<type>[scope]: <description>`
- type必须为：feat, fix, docs, style, refactor, test, chore
- 示例：`feat(parking): 添加停车场搜索功能`

### 9.2 分支管理

- `main`: 生产环境分支
- `develop`: 开发分支
- `feature/*`: 功能开发分支
- `hotfix/*`: 紧急修复分支

## 15. 附录

- 保持API文档与实际代码同步
- 关键功能必须有详细的使用说明
- 项目配置和环境要求必须文档化
- 定期更新开发规范文档

## 11. 最佳实践

### 11.1 页面生命周期管理

- onLoad: 初始化数据，只执行一次
- onShow: 每次显示页面时执行，适合刷新数据
- onReady: 页面初次渲染完成，适合操作DOM
- onHide: 页面隐藏时执行清理工作
- onUnload: 页面卸载时执行资源释放

### 11.2 数据状态管理

- 使用Page.data管理页面状态
- 复杂状态考虑使用globalData或状态管理库
- 数据更新必须使用setData方法
- 避免在模板中直接修改数据

### 11.3 用户体验优化

- 添加加载状态提示
- 实现下拉刷新和上拉加载更多
- 提供清晰的错误提示
- 优化页面切换动画

## 12. 附录

### 12.1 微信小程序官方文档链接

- [微信小程序开发指南](https://developers.weixin.qq.com/miniprogram/dev/framework/)
- [微信小程序框架参考](https://developers.weixin.qq.com/miniprogram/dev/reference/)
- [微信小程序组件](https://developers.weixin.qq.com/miniprogram/dev/component/)
- [微信小程序API](https://developers.weixin.qq.com/miniprogram/dev/api/)
- [微信小程序服务端API](https://developers.weixin.qq.com/miniprogram/dev/OpenApiDoc/)

### 15.2 项目相关文档

- [API配置说明](API配置说明.md)
- [TREA开发环境规则文档](TREA开发环境规则文档-9f5367e55e.md)

### 15.3 术语定义

| 术语 | 定义 | 英文对应 |
|-----|------|---------|
| 预约锁定 | 系统为用户临时保留车位的状态（默认10分钟） | Reservation Lock |
| 无感支付 | 用户离场时自动完成扣费的支付方式 | 无感支付 |
| 地锁状态 | 车位地锁的物理状态（升锁/降锁/故障） | Lock Status |
| ETA | 预计到达时间（用户到达停车场的时间估算） | Estimated Time of Arrival |
| 车位周转率 | 单位时间内车位的重复使用次数 | Parking Space Turnover Rate |

### 15.4 缩写对照表

| 缩写 | 全称 | 使用场景 |
|-----|------|---------|
| AI | 人工智能 | 通用术语 |
| API | 应用程序编程接口 | 技术文档 |
| DB | 数据库 | 技术文档 |
| ENV | 环境 | 配置文件 |
| HTTP | 超文本传输协议 | 网络相关 |
| JSON | JavaScript对象表示法 | 数据格式 |
| SDK | 软件开发工具包 | 第三方集成 |

---

本文档基于微信小程序官方规范和项目实际需求制定，将随项目发展持续更新。所有开发人员必须严格遵守本规范，确保代码质量和项目一致性。