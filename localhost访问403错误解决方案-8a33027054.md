# localhost访问403错误解决方案

## 问题分析

根据您提供的错误截图（HTTP ERROR 403），服务器拒绝访问的原因为**权限认证失败**。这与项目中集成的Spring Security安全框架相关，默认对敏感接口实施了访问控制。

### 错误特征
- 错误码：**403 Forbidden**（服务器理解请求但拒绝授权）
- 可能原因：
  - 未提供有效的用户认证信息
  - 登录用户权限等级不足
  - 跨域资源共享(CORS)配置问题
  - CSRF保护机制拦截了请求

## 解决方案

### 方法一：使用测试账号登录获取访问权限

#### 1. 登录获取认证令牌
```bash
# 使用curl命令登录（终端执行）
curl -X POST http://localhost:8080/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"testuser","password":"123456"}'
```

#### 2. 登录成功响应
```json
{
  "code": 200,
  "message": "登录成功",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...", // JWT令牌
    "expiresIn": 3600,
    "user": {
      "id": 1001,
      "username": "testuser",
      "roles": ["USER"]
    }
  }
}
```

#### 3. 使用令牌访问受保护接口
```bash
# 在请求头中携带令牌
curl -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." \
  http://localhost:8080/api/user/profile
```

### 方法二：修改Spring Security配置（开发环境专用）

#### 1. 创建开发环境安全配置类
```java
// src/main/java/com/parking/config/DevSecurityConfig.java
package com.parking.config;

import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.Profile;
import org.springframework.web.cors.CorsConfiguration;
import org.springframework.web.cors.UrlBasedCorsConfigurationSource;
import org.springframework.web.filter.CorsFilter;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;
import org.springframework.context.annotation.Bean;

@Configuration
@Profile("dev") // 仅开发环境生效
public class DevSecurityConfig extends WebSecurityConfigurerAdapter {

    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http
            // 开放所有接口访问权限
            .authorizeRequests()
                .anyRequest().permitAll()
            .and()
            // 禁用CSRF保护（开发环境简化测试）
            .csrf().disable()
            // 配置跨域访问
            .cors().configurationSource(corsConfigurationSource());
    }

    /**
     * 配置跨域资源共享
     */
    @Bean
    public CorsFilter corsConfigurationSource() {
        CorsConfiguration config = new CorsConfiguration();
        // 允许所有域名访问（开发环境）
        config.addAllowedOrigin("*");
        // 允许所有HTTP方法
        config.addAllowedMethod("*");
        // 允许所有请求头
        config.addAllowedHeader("*");
        // 允许携带认证信息
        config.setAllowCredentials(true);
        
        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
        source.registerCorsConfiguration("/**", config);
        return new CorsFilter(source);
    }
}
```

#### 2. 重启应用（指定dev环境）
```bash
# 使用Maven命令启动
mvn spring-boot:run -Dspring-boot.run.profiles=dev

# 或使用Java命令
java -jar target/parking-system-1.0.0.jar --spring.profiles.active=dev
```

### 方法三：前端请求头配置修正

如果使用前端框架（如Vue/React）访问后端接口，需在请求中添加认证令牌：

#### Vue示例（添加请求拦截器）
```javascript
// src/utils/request.js
import axios from 'axios';

// 创建axios实例
const service = axios.create({
  baseURL: 'http://localhost:8080',
  timeout: 5000
});

// 请求拦截器
service.interceptors.request.use(
  config => {
    // 从localStorage获取令牌
    const token = localStorage.getItem('token');
    if (token) {
      // 添加认证头
      config.headers.Authorization = `Bearer ${token}`;
    }
    return config;
  },
  error => {
    return Promise.reject(error);
  }
);

export default service;
```

## 验证解决方案

### 1. 基础健康检查
访问无需认证的公共接口验证服务状态：
```bash
curl http://localhost:8080/api/public/health
```
成功响应：
```json
{
  "status": "UP",
  "timestamp": "2025-10-16T11:30:45",
  "services": {
    "database": "UP",
    "redis": "UP"
  }
}
```

### 2. 接口文档访问
开发环境可通过Swagger UI浏览所有接口：
```
http://localhost:8080/swagger-ui.html
```

## 常见问题排查

### 1. 服务未启动
- 检查服务进程：`ps -ef | grep parking-system`
- 查看启动日志：`tail -f logs/application.log`
- 启动命令：`mvn spring-boot:run`

### 2. 端口被占用
- 查找占用进程：`lsof -i:8080`
- 终止进程：`kill -9 [进程ID]`
- 修改端口：在application-dev.properties中设置`server.port=8081`

### 3. 配置未生效
- 确认激活的环境：`grep "The following profiles are active" logs/application.log`
- 检查配置文件位置：确保DevSecurityConfig.java在src/main/java目录下
- 强制重新编译：`mvn clean compile`

## 生产环境注意事项

开发环境的宽松配置**绝对不能用于生产环境**，生产环境必须：
- 启用CSRF保护
- 严格配置CORS允许的域名
- 使用HTTPS加密传输
- 实施细粒度的RBAC权限控制
- 定期轮换JWT密钥
- 设置合理的令牌过期时间（建议1小时）

详细的生产环境安全配置请参考《系统部署与运维手册》第6章"安全运维"。