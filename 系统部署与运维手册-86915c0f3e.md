# 系统部署与运维手册

## 1. 部署架构设计

### 1.1 服务器架构
| 服务类型 | 生产环境配置 | 数量 | 主要职责 |
|---------|------------|------|---------|
| 应用服务器 | 16核32G/100G SSD | 3台 | 部署Spring Boot应用，负载均衡 |
| 数据库服务器 | 16核64G/500G SSD | 2台 | MySQL主从架构，主写从读 |
| 缓存服务器 | 8核16G/100G SSD | 2台 | Redis集群，主从+哨兵模式 |
| 文件服务器 | 8核16G/1T SSD | 1台 | 存储用户头像、车位图片等静态资源 |
| 监控服务器 | 8核16G/200G SSD | 1台 | 部署Prometheus、Grafana、ELK |

### 1.2 网络拓扑设计
```
[用户] → [CDN] → [负载均衡器(NGINX)] → [应用服务器集群] → [数据库集群/Redis集群]
                                    ↓
                              [防火墙] → [第三方服务API]
                                    ↓
                              [监控系统]
```

### 1.3 高可用方案
- **应用层高可用**：多实例部署+负载均衡，支持故障自动转移
- **数据层高可用**：MySQL主从复制，主库故障后30秒内自动切换到从库
- **缓存层高可用**：Redis主从+哨兵模式，支持节点故障自动恢复
- **数据备份**：每日凌晨2点全量备份+实时binlog日志，支持任意时间点恢复

## 2. 环境部署流程

### 2.1 环境规划
| 环境 | 用途 | 访问地址 | 数据库 | 部署方式 |
|-----|------|---------|--------|---------|
| 开发环境 | 日常开发测试 | dev.parking-system.com | H2内存数据库 | 本地Docker Compose |
| 测试环境 | 功能测试/集成测试 | test.parking-system.com | MySQL单节点 | 容器化部署 |
| 生产环境 | 线上服务 | parking-system.com | MySQL主从+Redis集群 | 容器化+自动化部署 |

### 2.2 Docker容器化部署
#### 2.2.1 应用Dockerfile
```dockerfile
FROM openjdk:17-jdk-slim
WORKDIR /app
COPY target/parking-system-1.0.0.jar app.jar
ENV SPRING_PROFILES_ACTIVE=prod
ENV JAVA_OPTS="-Xms2g -Xmx4g"
EXPOSE 8080
ENTRYPOINT ["sh", "-c", "java $JAVA_OPTS -jar app.jar"]
```

#### 2.2.2 Docker Compose配置
```yaml
version: '3.8'
services:
  app:
    build: .
    ports:
      - "8080:8080"
    depends_on:
      - mysql
      - redis
    environment:
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/parking
      - SPRING_REDIS_HOST=redis
    restart: always
    
  mysql:
    image: mysql:8.0
    volumes:
      - mysql-data:/var/lib/mysql
      - ./sql:/docker-entrypoint-initdb.d
    environment:
      - MYSQL_ROOT_PASSWORD=xxx
      - MYSQL_DATABASE=parking
    restart: always
    
  redis:
    image: redis:6.2
    volumes:
      - redis-data:/data
    command: redis-server --requirepass xxx
    restart: always

volumes:
  mysql-data:
  redis-data:
```

## 2. 环境部署流程

### 2.3 数据库部署
1. **初始化步骤**：
   ```bash
   # 创建数据库
   mysql -u root -p -e "CREATE DATABASE parking CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"
   
   # 执行初始化脚本
   mysql -u root -p parking < sql/schema.sql
   mysql -u root -p parking < sql/data.sql
   
   # 创建只读用户
   mysql -u root -p -e "CREATE USER 'readonly'@'%' IDENTIFIED BY 'xxx'; GRANT SELECT ON parking.* TO 'readonly'@'%';"
   ```

2. **主从配置**：
   - 主库配置（my.cnf）：
     ```ini
     [mysqld]
     server-id=1
     log_bin=mysql-bin
     binlog_do_db=parking
     ```
   - 从库配置（my.cnf）：
     ```ini
     [mysqld]
     server-id=2
     relay_log=mysql-relay-bin
     replicate_do_db=parking
     ```

### 2.4 应用部署流程
1. 构建应用包：`mvn clean package -Dmaven.test.skip=true`
2. 构建Docker镜像：`docker build -t parking-system:1.0.0 .`
3. 推送镜像到私有仓库：`docker push registry.example.com/parking-system:1.0.0`
4. 远程部署：`docker-compose pull && docker-compose up -d`

## 3. 监控告警系统

### 3.1 关键指标监控
- **系统指标**：CPU使用率（阈值≤80%）、内存使用率（阈值≤85%）、磁盘使用率（阈值≤85%）
- **应用指标**：接口响应时间（阈值≤500ms）、请求错误率（阈值≤0.1%）、JVM内存使用
- **数据库指标**：连接数（阈值≤500）、慢查询数（阈值≤10次/分钟）、主从同步延迟（阈值≤10s）

### 3.2 Prometheus监控配置
```yaml
# prometheus.yml
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'spring-actuator'
    metrics_path: '/actuator/prometheus'
    static_configs:
      - targets: ['app1:8080', 'app2:8080', 'app3:8080']
  
  - job_name: 'mysql'
    static_configs:
      - targets: ['mysql-exporter:9104']
  
  - job_name: 'redis'
    static_configs:
      - targets: ['redis-exporter:9121']
```

### 3.3 日志收集与分析
- **ELK栈部署**：
  - Filebeat收集应用日志 → Logstash处理 → Elasticsearch存储 → Kibana展示
- **日志格式规范**：
  ```json
  {
    "timestamp": "2025-10-16 10:00:00",
    "level": "INFO",
    "thread": "http-nio-8080-exec-1",
    "class": "com.parking.controller.ReservationController",
    "message": "用户预约车位成功",
    "userId": "U12345",
    "parkingId": "P6789",
    "reservationId": "R10001"
  }
  ```

### 3.4 告警机制设计
- **告警级别**：
  - P0（紧急）：服务不可用，立即处理（15分钟响应）
  - P1（重要）：性能严重下降，影响用户体验（30分钟响应）
  - P2（一般）：非核心功能异常，不影响主流程（2小时响应）
  - P3（提示）：系统优化建议（24小时响应）
- **通知渠道**：企业微信群机器人、短信（P0/P1）、邮件（所有级别）

## 4. 运维自动化

### 4.1 自动化部署脚本（Ansible）
```yaml
# deploy.yml
- hosts: production_servers
  tasks:
    - name: 拉取最新镜像
      docker_image:
        name: registry.example.com/parking-system:latest
        source: pull
    
    - name: 停止旧容器
      docker_compose:
        project_src: /opt/parking
        state: stopped
    
    - name: 启动新容器
      docker_compose:
        project_src: /opt/parking
        state: present
    
    - name: 检查服务状态
      uri:
        url: http://localhost:8080/actuator/health
        status_code: 200
```

### 4.2 数据库备份策略
- **全量备份**：每日凌晨2点执行
  ```bash
  #!/bin/bash
  BACKUP_DIR="/backup/mysql"
  DATE=$(date +%Y%m%d)
  mysqldump -u root -p'xxx' --all-databases > $BACKUP_DIR/full_$DATE.sql
  gzip $BACKUP_DIR/full_$DATE.sql
  # 保留最近30天备份
  find $BACKUP_DIR -name "full_*.sql.gz" -mtime +30 -delete
  ```

- **增量备份**：启用MySQL binlog，每小时归档一次
- **备份验证**：每周日自动恢复备份到测试环境，验证数据完整性

### 4.3 系统健康检查
```bash
#!/bin/bash
# 检查应用是否存活
curl -s http://localhost:8080/actuator/health | grep "UP" || exit 1

# 检查数据库连接
mysql -u readonly -p'xxx' -e "SELECT 1" > /dev/null 2>&1 || exit 1

# 检查Redis连接
redis-cli -a 'xxx' PING | grep "PONG" || exit 1

# 检查磁盘空间
df -h | awk '$5 > 85 {print "磁盘空间不足:" $0; exit 1}'

exit 0
```

## 5. 故障处理流程

### 5.1 常见故障排查指南
#### 5.1.1 应用服务不可用
1. 检查容器状态：`docker ps | grep parking-system`
2. 查看应用日志：`docker logs -f parking-system_app_1`
3. 检查JVM状态：`jstack [PID] > jstack.log`（分析线程死锁）
4. 检查系统资源：`top`、`free -m`、`df -h`

#### 5.1.2 数据库连接异常
1. 检查数据库状态：`systemctl status mysqld`
2. 查看数据库日志：`tail -f /var/log/mysqld.log`
3. 检查连接数：`mysql -u root -p -e "show processlist;"`
4. 验证数据库账号密码：`mysql -u [username] -p[password]`

### 5.2 应急响应机制
1. **故障上报流程**：
   - 运维人员发现故障 → 通知技术负责人 → 成立应急小组 → 故障处理 → 事后复盘
2. **处理优先级划分**：
   - 一级（服务中断）：立即处理，暂停所有非紧急工作
   - 二级（性能下降）：优先处理，延迟非紧急需求
   - 三级（功能异常）：按计划处理，纳入迭代修复

### 5.3 事后复盘流程
1. 故障描述（现象、影响范围、持续时间）
2. 根本原因分析（5 Why分析法）
3. 解决方案和预防措施
4. 改进计划（流程/制度/技术优化）
5. 经验总结与分享

## 6. 安全运维

### 6.1 服务器安全加固
- 禁用root直接登录，使用sudo权限管理
- 配置防火墙，只开放必要端口（80/443/22）
- 定期更新系统补丁：`yum update -y`
- 启用SELinux，限制进程权限

### 6.2 数据安全措施
- 敏感数据加密存储（用户密码bcrypt加密，支付信息AES加密）
- 数据库定期备份，异地存储
- 传输数据加密（全站HTTPS，API通信TLS 1.3）
- 定期安全审计，使用Nessus扫描漏洞

## 7. 运维文档管理

### 7.1 文档版本控制
- 所有运维文档纳入Git管理，遵循"修改即提交"原则
- 文档版本与系统版本保持一致，每次重大变更更新文档版本

### 7.2 知识库建设
- 故障处理案例库（问题现象→原因→解决方案）
- 运维工具使用手册（监控系统/自动化脚本使用方法）
- 系统架构图、网络拓扑图定期更新