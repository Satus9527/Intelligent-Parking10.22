# 后端工程搭建指南

## 1. 开发环境准备

### 1.1 核心组件版本要求
| 组件 | 版本要求 | 验证命令 |
|------|----------|----------|
| JDK | 11.0.15+ | `java -version` |
| Maven | 3.8.5+ | `mvn -v` |
| MySQL | 8.0.28+ | `mysql --version` |
| Redis | 6.2.6+ | `redis-server --version` |
| Spring Boot | 2.7.5 | pom.xml配置 |

### 1.2 环境变量配置
创建`.env`文件并配置以下参数：
```properties
# 数据库配置
DB_URL=jdbc:mysql://localhost:3306/parking_db?useSSL=false&serverTimezone=UTC
DB_USERNAME=parking_admin
DB_PASSWORD=${ENCRYPTED_PASSWORD}
# 第三方服务配置
AMAP_API_KEY=your_amap_api_key
PAYMENT_API_KEY=your_payment_api_key
# 应用配置
APP_ENV=dev
LOG_LEVEL=INFO
CACHE_ENABLED=true
```

> **安全要求**：敏感信息必须通过环境变量注入，禁止硬编码（参考TREA开发环境规则4.2.3条）

### 1.3 依赖管理策略
在`pom.xml`中添加核心依赖：
```xml
<!-- Spring Boot核心 -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-web</artifactId>
</dependency>
<!-- 数据访问 -->
<dependency>
    <groupId>org.mybatis.spring.boot</groupId>
    <artifactId>mybatis-spring-boot-starter</artifactId>
    <version>2.2.2</version>
</dependency>
<!-- 缓存 -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-redis</artifactId>
</dependency>
<!-- 安全 -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-security</artifactId>
</dependency>
```

## 2. 项目结构设计

### 2.1 标准目录树
```
src/
├── main/
│   ├── java/com/parking/
│   │   ├── controller/      # 接口层
│   │   ├── service/         # 业务逻辑层
│   │   │   ├── impl/        # 服务实现
│   │   ├── dao/             # 数据访问层
│   │   ├── model/           # 数据模型
│   │   │   ├── entity/      # 数据库实体
│   │   │   ├── dto/         # 数据传输对象
│   │   │   ├── vo/          # 视图对象
│   │   ├── config/          # 配置类
│   │   ├── util/            # 工具类
│   │   ├── exception/       # 异常处理
│   │   └── ParkingApplication.java  # 启动类
│   ├── resources/
│   │   ├── application.yml  # 主配置文件
│   │   ├── application-dev.yml  # 开发环境配置
│   │   ├── mapper/          # MyBatis映射文件
│   │   └── static/          # 静态资源
└── test/                    # 测试代码
```

### 2.2 命名规范示例
| 文件类型 | 命名规则 | 正确示例 | 错误示例 |
|----------|----------|----------|----------|
| 控制器 | 业务+Controller | ParkingController.java | ParkingCtrl.java |
| 服务接口 | 业务+Service | ParkingService.java | IParking.java |
| 实体类 | 表名+Entity | ParkingSpaceEntity.java | ParkingSpace.java |
| DTO | 功能+DTO | ReserveDTO.java | ReserveData.java |

## 3. 核心配置实现

### 3.1 数据库配置
`application-dev.yml`配置：
```yaml
spring:
  datasource:
    url: ${DB_URL}
    username: ${DB_USERNAME}
    password: ${DB_PASSWORD}
    driver-class-name: com.mysql.cj.jdbc.Driver
  redis:
    host: localhost
    port: 6379
    timeout: 2000ms
mybatis:
  mapper-locations: classpath:mapper/*.xml
  type-aliases-package: com.parking.model.entity
```

### 3.2 高并发配置
```java
@Configuration
public class WebConfig implements WebMvcConfigurer {
    @Bean
    public ThreadPoolTaskExecutor taskExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setCorePoolSize(10);        // 核心线程数
        executor.setMaxPoolSize(20);         // 最大线程数
        executor.setQueueCapacity(100);      // 队列容量
        executor.setKeepAliveSeconds(60);    // 空闲线程存活时间
        executor.setThreadNamePrefix("parking-");
        return executor;
    }
}
```

### 3.3 第三方服务集成
高德地图API配置：
```java
@Configuration
public class AmapConfig {
    @Value("${AMAP_API_KEY}")
    private String apiKey;
    
    @Bean
    public AmapClient amapClient() {
        return new AmapClient.Builder()
                .apiKey(apiKey)
                .timeout(3000)
                .retryCount(2)
                .build();
    }
}
```

## 4. 安全编码实现

### 4.1 接口权限控制
```java
@RestController
@RequestMapping("/api/v1/parking")
public class ParkingController {
    @PostMapping("/reserve")
    @PreAuthorize("hasRole('USER')")
    public ResultDTO reserveParking(@RequestBody @Valid ReserveDTO reserveDTO) {
        // 业务逻辑
    }
}
```

### 4.2 输入验证
```java
public class ReserveDTO {
    @NotNull(message = "车位ID不能为空")
    private Long spaceId;
    
    @Future(message = "预约时间必须为未来时间")
    @JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss")
    private LocalDateTime reserveTime;
    
    @Pattern(regexp = "^1[3-9]\\d{9}$", message = "手机号格式错误")
    private String phone;
}
```

## 5. 测试与构建配置

### 5.1 单元测试示例
```java
@SpringBootTest
public class ParkingServiceTest {
    @Autowired
    private ParkingService parkingService;
    
    @Test
    public void testReserveParking() {
        ReserveDTO dto = new ReserveDTO();
        dto.setSpaceId(1L);
        dto.setReserveTime(LocalDateTime.now().plusHours(1));
        dto.setPhone("13800138000");
        
        ResultDTO result = parkingService.reserve(dto);
        assertTrue(result.isSuccess());
    }
}
```

### 5.2 构建命令
```bash
# 编译打包
mvn clean package -DskipTests
# 运行测试
mvn test
# 代码检查
mvn checkstyle:check
```

## 6. 部署准备清单
- [ ] 环境变量配置文件已创建
- [ ] 数据库表结构已初始化（执行`sql/init_schema.sql`）
- [ ] Redis服务已启动并配置持久化
- [ ] API密钥已通过环境变量注入
- [ ] 应用日志目录已配置且权限正确
- [ ] 已执行`mvn package`生成可执行JAR包

## 7. 关键问题解决方案

### 7.1 数据库连接池优化
```yaml
spring:
  datasource:
    hikari:
      maximum-pool-size: 20
      minimum-idle: 5
      idle-timeout: 300000
      connection-timeout: 2000
```

### 7.2 缓存策略实现
```java
@Service
public class ParkingServiceImpl implements ParkingService {
    @Cacheable(value = "parkingSpace", key = "#spaceId")
    public ParkingSpaceDTO getParkingSpace(Long spaceId) {
        // 数据库查询逻辑
    }
}
```

### 7.3 并发控制实现
```java
@Transactional
public ResultDTO reserveParking(ReserveDTO dto) {
    // 悲观锁保证并发安全
    int affected = parkingSpaceMapper.lockSpace(dto.getSpaceId());
    if (affected == 0) {
        return ResultDTO.fail("车位已被占用");
    }
    // 业务逻辑处理
}
```